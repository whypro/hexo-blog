<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="在用 python 编写多线程程序时，经常需要用 Ctrl + C 中止进程，可是大家都知道，在 python 中，除了主线程可以响应控制台的 Ctrl + C ，其他线程是无法捕获到的，也就是说，当主线程被中止后，其他线程也会被强制中止，这样线程们就没有机会处理自己还没有完成的工作。而在实际应用中"><meta name="author" content="whypro"><meta property="og:title" content="Python 多线程响应 Ctrl + C，用 Event 实现"><meta property="og:site_name" content="Everlasting"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>Python 多线程响应 Ctrl + C，用 Event 实现 - Everlasting</title><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"><link rel="stylesheet" href="/hexo-blog/css/style.css"></head><body><div class="bg-gradient"></div><div class="bg-pattern"></div><div class="menu-bg"><div class="menu-container"><ul><li class="menu-item"><a href="/hexo-blog/">Home</a></li><li class="menu-item"><a href="/hexo-blog/archives">Archives</a></li><li class="menu-item"><a href="/hexo-blog/about.html">About</a></li><li class="menu-item"><a href="/hexo-blog/tags">Tags</a></li><li class="menu-item"><a href="/hexo-blog/categories">Categories</a></li><li class="menu-item"><a href="/hexo-blog/contact.html">Contact</a></li></ul></div></div><nav><a href="#menu"></a></nav><div class="container"><div class="row"><div class="col-sm-12"><header><div class="logo"><a href="/hexo-blog/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a></div></header><section class="main"><div class="post"><div class="post-header"><h1 class="title"><a href="/hexo-blog/20130505/Python-多线程响应-Ctrl-C，用-Event-实现/">Python 多线程响应 Ctrl + C，用 Event 实现</a></h1><div class="post-info"><span class="date">2013-05-05</span></div></div><div class="content"><p>在用 python 编写多线程程序时，经常需要用 Ctrl + C 中止进程，可是大家都知道，在 python 中，除了主线程可以响应控制台的 Ctrl + C ，其他线程是无法捕获到的，也就是说，当主线程被中止后，其他线程也会被强制中止，这样线程们就没有机会处理自己还没有完成的工作。</p><p>而在实际应用中，我们可能会有这样的要求：</p><ol><li><p>当按下 Ctrl + C 时，我们希望所有线程先处理完自己的任务，再主动停止</p></li><li><p>当所有线程停止后，主线程才终止</p></li></ol><p>【<a href="http://my.oschina.net/apoptosis/blog/125099" target="_blank" rel="noopener">这篇文章</a>】提供了一种方法，我对其做了进一步改进，写了如下的代码，希望能起到抛砖引玉的作用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, thread_num)</span>:</span></span><br><span class="line">        self.thread_num = thread_num        <span class="comment"># 线程个数</span></span><br><span class="line">        self.outLock = threading.Lock()     <span class="comment"># 控制台输出锁</span></span><br><span class="line">        self.threads = []                   <span class="comment"># 线程列表</span></span><br><span class="line">        self.interruptEvent = threading.Event() <span class="comment"># 键盘中断事件</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">beginTask</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 将线程加入线程列表</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.thread_num):</span><br><span class="line">            t_name = str(i + <span class="number">1</span>)</span><br><span class="line">            thread = threading.Thread(target=self.doSomething, kwargs=&#123;<span class="string">"t_name"</span>: t_name&#125;)</span><br><span class="line">            self.threads.append(thread)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 启动线程</span></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> self.threads:</span><br><span class="line">            thread.start()</span><br><span class="line">        self.interruptEvent.clear()             <span class="comment"># clear</span></span><br><span class="line">        <span class="comment"># 用 isAlive 循环判断代替线程的 join 方法</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                alive = <span class="keyword">False</span></span><br><span class="line">                <span class="keyword">for</span> thread <span class="keyword">in</span> self.threads:</span><br><span class="line">                    alive = alive <span class="keyword">or</span> thread.isAlive()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> alive:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                self.interruptEvent.set()           <span class="comment"># set</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">doSomething</span><span class="params">(self, t_name)</span>:</span></span><br><span class="line">        self.outLock.acquire()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">u"线程 %s 已启动"</span> % t_name</span><br><span class="line">        self.outLock.release()</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> self.interruptEvent.isSet():     <span class="comment"># isSet</span></span><br><span class="line">                    <span class="keyword">raise</span> KeyboardInterrupt</span><br><span class="line">                <span class="comment">########################</span></span><br><span class="line">                <span class="comment"># doSomething 函数代码 #</span></span><br><span class="line">                <span class="comment">########################</span></span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                <span class="comment">##################</span></span><br><span class="line">                <span class="comment"># 处理最后的工作 #</span></span><br><span class="line">                <span class="comment">##################</span></span><br><span class="line">                self.outLock.acquire()</span><br><span class="line">                <span class="keyword">print</span> <span class="string">u"用户强制中止主线程，线程 %s 已中止"</span> % t_name</span><br><span class="line">                self.outLock.release()                </span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        self.outLock.acquire()</span><br><span class="line">        <span class="keyword">print</span> <span class="string">u"线程 %s 已停止"</span> % t_name</span><br><span class="line">        self.outLock.release()</span><br><span class="line">        </span><br><span class="line">                        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    t = MyThread(<span class="number">5</span>)</span><br><span class="line">    t.beginTask()</span><br></pre></td></tr></table></figure><p>程序启动后，如图 1 所示：</p><img src="/hexo-blog/20130505/Python-多线程响应-Ctrl-C，用-Event-实现/184109_ddmL_730461.png"><p>按下 Ctrl + C 后，如图 2 所示：</p><img src="/hexo-blog/20130505/Python-多线程响应-Ctrl-C，用-Event-实现/184123_2RT2_730461.png"><p>这样各个线程都有机会处理自己的任务后主动停止，随后主线程再终止。</p></div><div class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i> <a href="/hexo-blog/tags/原创/">#原创</a> <a href="/hexo-blog/tags/Python/">#Python</a> <a href="/hexo-blog/tags/多线程/">#多线程</a></div></div></section></div></div></div><div class="push"></div><footer class="footer-content"><div class="container"><div class="row"><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about"><h2>About</h2><p>This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.</p></div><div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts"><h2>Recent Posts</h2><ul><li><a class="footer-post" href="/hexo-blog/20190107/使用-Devstack-搭建-Openstack-集群/">使用 Devstack 搭建 Openstack</a></li><li><a class="footer-post" href="/hexo-blog/20180725/etcd-集群的备份和还原/">etcd 集群的备份和还原</a></li><li><a class="footer-post" href="/hexo-blog/20180301/Kubernetes-服务灰度升级最佳实践/">Kubernetes 服务灰度升级最佳实践</a></li><li><a class="footer-post" href="/hexo-blog/20180110/从头编写一款时间序列数据库/">从头编写一款时间序列数据库</a></li></ul></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><ul class="list-inline footer-social-icons"><li class="list-inline-item"><a href="https://github.com/whypro"><span class="footer-icon-container"><i class="fa fa-github"></i></span></a></li><li class="list-inline-item"><a href="https://twitter.com/"><span class="footer-icon-container"><i class="fa fa-twitter"></i></span></a></li><li class="list-inline-item"><a href="https://www.facebook.com/"><span class="footer-icon-container"><i class="fa fa-facebook"></i></span></a></li><li class="list-inline-item"><a href="mailto:whypro@live.cn"><span class="footer-icon-container"><i class="fa fa-envelope-o"></i></span></a></li></ul></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><div class="footer-copyright">@Everlasting. All right reserved | Design & Hexo <a href="http://whypro.github.io/hexo-blog/">whypro</a></div></div></div></div></footer><script src="//code.jquery.com/jquery-2.1.4.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script><script src="/hexo-blog/js/main.js"></script></body></html>