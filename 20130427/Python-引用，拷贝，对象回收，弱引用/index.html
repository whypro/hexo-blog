<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="引用python中，在对对象赋值，参数传递，函数返回等等, 都是引用传递的. 直接copy个例子来【1】：1234a = [1, 2, 3]b = ab.append(5)print a, b输出结果为：1[1, 2, 3, 5] [1, 2, 3, 5]面的结果有助于理解引用的实际情况。 具体查看"><meta name="author" content="whypro"><meta property="og:title" content="Python 引用，拷贝，对象回收，弱引用"><meta property="og:site_name" content="Everlasting"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>Python 引用，拷贝，对象回收，弱引用 - Everlasting</title><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"><link rel="stylesheet" href="/hexo-blog/css/style.css"></head><body><div class="bg-gradient"></div><div class="bg-pattern"></div><div class="menu-bg"><div class="menu-container"><ul><li class="menu-item"><a href="/hexo-blog/">Home</a></li><li class="menu-item"><a href="/hexo-blog/archives">Archives</a></li><li class="menu-item"><a href="/hexo-blog/about.html">About</a></li><li class="menu-item"><a href="/hexo-blog/tags">Tags</a></li><li class="menu-item"><a href="/hexo-blog/categories">Categories</a></li><li class="menu-item"><a href="/hexo-blog/contact.html">Contact</a></li></ul></div></div><nav><a href="#menu"></a></nav><div class="container"><div class="row"><div class="col-sm-12"><header><div class="logo"><a href="/hexo-blog/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a></div></header><section class="main"><div class="post"><div class="post-header"><h1 class="title"><a href="/hexo-blog/20130427/Python-引用，拷贝，对象回收，弱引用/">Python 引用，拷贝，对象回收，弱引用</a></h1><div class="post-info"><span class="date">2013-04-27</span></div></div><div class="content"><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>python中，在对对象赋值，参数传递，函数返回等等, 都是引用传递的. 直接copy个例子来【1】：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">b = a</span><br><span class="line">b.append(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">print</span> a, b</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3, 5] [1, 2, 3, 5]</span><br></pre></td></tr></table></figure><p>面的结果有助于理解引用的实际情况。 具体查看一个对象的引用数，可以使用sys.getrefcount(ojb)获取，但这个函数有点邪恶，有时似乎并不给出正确的结果，正常来说获取的值都比你想要的大，一般是大1，因为给这个函数传参数也算一个引用。但有时会大得离谱，来例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">a = <span class="string">"a"</span></span><br><span class="line">sys.getrefcount(a)</span><br></pre></td></tr></table></figure><p>在我的机器上，输出结果尽然为14，网络遛了一圈，有人说是python内部对“a”这个对象进行了引用。好吧！就这样理解把，有高见的可以留言告我一下！</p><h2 id="拷贝【1】"><a href="#拷贝【1】" class="headerlink" title="拷贝【1】"></a>拷贝【1】</h2><p>拷贝主要有两种拷贝，分别以copy模块中的两个函数copy和deepcopy为代表。其中，前者复制对象本身，但对于对象中得元素，还是会使用的原本引用，copy个例子来：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list_of_lists = [ [<span class="string">'a'</span>], [<span class="number">1</span>, <span class="number">2</span>], [<span class="string">'z'</span>, <span class="number">23</span>] ]</span><br><span class="line">copy_lol = copy.copy(lists_of_lists)</span><br><span class="line">copy_lol[<span class="number">1</span>].append(<span class="string">'boo'</span>)</span><br><span class="line"><span class="keyword">print</span> list_of_lists, copy_lol</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[&apos;a&apos;], [1, 2, &apos;boo&apos;], [&apos;z&apos;, 23]] [[&apos;a&apos;], [1, 2, &apos;boo&apos;], [&apos;z&apos;, 23]]</span><br></pre></td></tr></table></figure><p>考到第二个元素的情况了 把！用的还是引用。要想全部对对象本省进行拷贝，就得使用deepcopy了。</p><h2 id="对象回收"><a href="#对象回收" class="headerlink" title="对象回收"></a>对象回收</h2><p>Python使用了垃圾回收器来自动销毁那些不再使用的对象。当对某个对象的引用计数为0时， Python能够安全地销毁这个对象。表面上看来，在使用C或者C++时经常会碰到的内存泄露问题似乎也就解决了，但实际的情况是，请你小心！再copy个例子来【2】：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeakTest</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">print</span> <span class="string">'Object with id %d born here.'</span> % id(self)</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">print</span> <span class="string">'Object with id %d dead here.'</span> % id(self)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">   A = LeakTest()</span><br><span class="line">   B = LeakTest()</span><br><span class="line">   A.b = B</span><br><span class="line">   B.a = A</span><br><span class="line"><span class="keyword">if</span> __name__ = =<span class="string">"__main__"</span>: </span><br><span class="line">  foo()</span><br></pre></td></tr></table></figure><p>运行结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object with id 10462448 born here.</span><br><span class="line">Object with id 10462832 born here.</span><br></pre></td></tr></table></figure><p>在构造一个类时，__init__会被自动调用；在进行对象回收时，__del__会被调用。很清楚的看到对象只是被创建了，而没有被回收，原因很简单，A和B的由于互相引用，他们的引用次数是不可能为0的，自然被回收也是不可能的了。这是，就应该考虑弱引用了。</p><h2 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h2><p>这是相对上面“引用”的一个概念，主要不同体现在对象回收时，上面我只提到当引用数为0，对象就会自动回收。其实还有另外一种情况，当自由只有对对象的弱引用时，对象也是会被回收。直接上代码，对上例做出一些修改：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeakTest</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">print</span> <span class="string">'Object with id %d born here.'</span> % id(self)</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">print</span> <span class="string">'Object with id %d dead here.'</span> % id(self)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">   A = LeakTest()</span><br><span class="line">   B = LeakTest()</span><br><span class="line">   A.b = weakref.proxy(B)</span><br><span class="line">   B.a = weakref.proxy(A)</span><br><span class="line"><span class="keyword">if</span> __name__ = =<span class="string">"__main__"</span>: </span><br><span class="line">  foo()</span><br></pre></td></tr></table></figure><p>运行结果为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object with id 28637456 born here.</span><br><span class="line">Object with id 29402736 born here.</span><br><span class="line">Object with id 28637456 dead here.</span><br><span class="line">Object with id 29402736 dead here.</span><br></pre></td></tr></table></figure><p>OK了，对象被正常回收了！最后简单解说wekref中得几个函数【3】：</p><p>1. 创建弱引用：</p><p>你可以通过调用weakref模块的ref(obj[,callback])来创建一个弱引用，obj是你想弱引用的对象，callback是一个可选的函数，当因没有引用导致Python要销毁这个对象时调用。回调函数callback要求单个参数（弱引用的对象）。<br>一旦你有了一个对象的弱引用，你就能通过调用弱引用来获取被弱引用的对象。下面的例子创建了一个对socket对象的弱引用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from socket import * </span><br><span class="line">&gt;&gt;&gt; import weakref </span><br><span class="line">&gt;&gt;&gt; s=socket(AF_INET,SOCK_STREAM) </span><br><span class="line">&gt;&gt;&gt; ref=weakref.ref(s) </span><br><span class="line">&gt;&gt;&gt; s </span><br><span class="line">&lt;socket._socketobject instance at 007B4A94&gt; </span><br><span class="line">&gt;&gt;&gt; ref </span><br><span class="line">&lt;weakref at 0x81195c; to &apos;instance&apos; at 0x7b4a94&gt; </span><br><span class="line">&gt;&gt;&gt; ref()    #调用它来访问被引用的对象 </span><br><span class="line">&lt;socket.socketobject instance at 007B4A94&gt;</span><br></pre></td></tr></table></figure><p>2. 创建代理对象<br>代理对象是弱引用对象，它们的行为就像它们所引用的对象，这就便于你不必首先调用弱引用来访问背后的对象。通过weakref模块的proxy(obj[,callback])函数来创建代理对象。使用代理对象就如同使用对象本身一样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from socket import * </span><br><span class="line">&gt;&gt;&gt; import weakref </span><br><span class="line">&gt;&gt;&gt; s=socket(AF_INET,SOCK_STREAM) </span><br><span class="line">&gt;&gt;&gt; ref=weakref.proxy(s) </span><br><span class="line">&gt;&gt;&gt; s </span><br><span class="line">&lt;socket._socketobject instance at 007E4874&gt; </span><br><span class="line">&gt;&gt;&gt; ref </span><br><span class="line">&lt;socket._socketobject instance at 007E4874&gt; </span><br><span class="line">&gt;&gt;&gt; ref.close() #对象的方法同样工作</span><br></pre></td></tr></table></figure><p>callback参数的目的和ref函数相同。在Python删除了一个引用的对象之后，使用代理将会导致一个weakref.ReferenceError错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; del s </span><br><span class="line">&gt;&gt;&gt; ref </span><br><span class="line">Traceback (most recent call last): </span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in ?</span><br></pre></td></tr></table></figure><p>3. getweakrefcount(obj)和getweakrefs(obj)分别返回弱引用数和关于所给对象的引用列表</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>【1】 <a href="http://blog.sina.com.cn/s/blog_5357c0af0100n2q5.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_5357c0af0100n2q5.html</a></p><p>【2】<a href="http://linhs.blog.51cto.com/370259/142846/" target="_blank" rel="noopener">http://linhs.blog.51cto.com/370259/142846/</a></p><p>【3】<a href="http://longmans1985.blog.163.com/blog/static/70605475200991613556128/" target="_blank" rel="noopener">http://longmans1985.blog.163.com/blog/static/70605475200991613556128/</a></p></div><div class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i> <a href="/hexo-blog/tags/原创/">#原创</a> <a href="/hexo-blog/tags/Python/">#Python</a></div></div></section></div></div></div><div class="push"></div><footer class="footer-content"><div class="container"><div class="row"><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about"><h2>About</h2><p>This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.</p></div><div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts"><h2>Recent Posts</h2><ul><li><a class="footer-post" href="/hexo-blog/20190107/使用-Devstack-搭建-Openstack-集群/">使用 Devstack 搭建 Openstack</a></li><li><a class="footer-post" href="/hexo-blog/20180725/etcd-集群的备份和还原/">etcd 集群的备份和还原</a></li><li><a class="footer-post" href="/hexo-blog/20180301/Kubernetes-服务灰度升级最佳实践/">Kubernetes 服务灰度升级最佳实践</a></li><li><a class="footer-post" href="/hexo-blog/20180110/从头编写一款时间序列数据库/">从头编写一款时间序列数据库</a></li></ul></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><ul class="list-inline footer-social-icons"><li class="list-inline-item"><a href="https://github.com/whypro"><span class="footer-icon-container"><i class="fa fa-github"></i></span></a></li><li class="list-inline-item"><a href="https://twitter.com/"><span class="footer-icon-container"><i class="fa fa-twitter"></i></span></a></li><li class="list-inline-item"><a href="https://www.facebook.com/"><span class="footer-icon-container"><i class="fa fa-facebook"></i></span></a></li><li class="list-inline-item"><a href="mailto:whypro@live.cn"><span class="footer-icon-container"><i class="fa fa-envelope-o"></i></span></a></li></ul></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><div class="footer-copyright">@Everlasting. All right reserved | Design & Hexo <a href="http://whypro.github.io/hexo-blog/">whypro</a></div></div></div></div></footer><script src="//code.jquery.com/jquery-2.1.4.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script><script src="/hexo-blog/js/main.js"></script></body></html>