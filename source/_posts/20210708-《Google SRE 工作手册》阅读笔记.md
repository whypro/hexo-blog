---
title: 《Google SRE 工作手册》阅读笔记
tags:
  - SRE
  - 读书笔记
  - Google
  - 原创
categories: []
toc: true
date: 2021-07-08 22:55:25
updated: 2021-07-26 00:18:47
---

## SRE 与 DevOps 的关系
站点可靠性工程师（SRE）是 Google 工程副总裁 Ben Treynor Sloss 创造的术语。DevOps 是一种理念和工作方法，SRE 是 DevOps 的实现，比 DevOps 更具体、更清晰。

### DevOps 核心思想

- 运维和开发团队不应该独立，各自为政，需要打穿部门墙。
- 意外不可避免，缺少保障措施才是问题。重心应该放在如何从故障中恢复，而不是防范故障的发生。
- 每次变更要尽量小，变更次数要尽量多。不应该为了提高效率或者为了“降低”风险，把变更积攒起来一起做。应该用正确的方式面对变更的风险，比如将其拆分为规模更小、风险也更小的变更，拼接起来形成一个前向稳定的变更序列，并在实施过程中不断优化变更流程，实现变更管理方式的转型。
- 自动化工具固然非常重要，但工程师文化更重要，良好的文化可以解决糟糕工具造成的麻烦，反之不然。
- 统一的度量是不同部门之间沟通的基石。

### SRE 核心思想
- 做好运维是一个软件开发问题。SRE 应该使用软件工程的方法来解决问题。
- 不企图提供 100% 的可用性。应该以服务质量目标（SLO）为准绳，任何设计不应该违反 SLO。
- 尽量减少琐事，琐事不是工作。在运维任务上多花一分钟，在项目上就少了一分钟。虽然合理的运维任务可以更好地为设计系统提供信息，但是项目工作才能提高服务的可靠性和扩展性。
- 确定自动化目标（哪些需要自动化，什么条件下的自动化，如何自动化）。团队成员在琐事上花费的时间不能超过 50%。
- 减少常规故障平均修复时间（MTTR），会提升开发人员的迭代速度。
- 理想情况下 SRE 和产品团队都应该对技术栈有整体的了解（包括前端、后端、存储、内核、物理机），SRE 需要和产品团队共享服务的所有权。
- 负责同一个服务的不同团队应该使用相同的工具，这样优化工具的成本越小，收益更大。

<!-- more -->

### SRE 与 DevOps 的异同

共同点：
- 都认为实施改变是进步的源泉，没有改变就没有太大的操作空间。
- 都会在整个组织中广泛传播自己的理念，让不同团队之间的壁垒更容易打破。
- 少量多次地做变更，大部分变更应该经历自动化测试和自动部署。
- 都以数据为基础，指定统一的度量至关重要。
- 推行对事不对人的时候总结，避免毫无建设性的互相指责。
- 都希望通过共同合作使整个团队（组织、企业）变得更好，都会带来更快的迭代速度。

不同点：
- DevOps 是一种更宽泛的理念和文化，比 SRE 影响范围更广，在不同环境中有不同的具体表现，不太涉及操作层面的细节。
- SRE 职责定义相对狭窄，面向服务而非面向整体业务。SRE 与 DevOps 所认可的东西相同，但认可的原因略有不同。

### DevOps 与 SRE 理念带来收益的前提条件
- 不要把激励措施与发布和可靠性成果联系在一起。
- 避免组织层面的甩锅，应该积极鼓励工程师做变更，并授予其较高的自由度。同时推行对事不对人的总结报告。停止对一些无可救药的产品的支持，“如果总是给他们分配过多的运维工作，而飞起了他们的真材实料，可能就辞职不干了”。
- 是否需要将 SRE 岗位规划成一个新的组织架构或部门，取决于公司规模，但要认识到专业化带来的优势与挑战。
- SRE 与开发团队的紧密合作，有助于在决策上可以达成一致的目标。
- DevOps/SRE 团队与开发团队应该要得到同等的尊重与激励。

## 实施 SLO

服务质量目标（Service Level Object，SLO），描述服务可靠性的程度，是 SRE 实践的核心。

### SLO 的重要性
SLO 是对可靠性工作的机会成本做出数据驱动型决策的关键，有利于合理安排可靠性工作的优先级。
SRE 受 SLO 驱动：捍卫短期 SLO，并确保可以在中长期内对其进行持续维护。

### SLO 入门

- 想要达到 100% 可靠性是一个错误的目标。
- 服务质量指标（Service Level Indicator，SLI）。建议将 SLI 视为两个数字的比率，比如成功实践数量/事件总数，范围是 0%-100%。SLO 就是目标的百分比数值，错误预算是 (100% - SLO)。
- SLI 规范与 SLI 实现，可用性、延时，时效性、耐用性、正确性、质量和覆盖率都可以成为有价值的 SLO。

### 范例系统分析

不同类型组件的潜在 SLI：
- 请求驱动：
    - 可用性（返回结果为成功的请求的比例）
    - 延迟（响应速度快于阈值的请求的比例）
    - 质量（服务降级比例）
- 流水线
    - 时效性（最近一次更新时间距现在小于某个时间阈值的数据的比例）
    - 正确率（已进入流水线的数据记录，正确地生成了处理结果的比例）
    - 覆盖率（处理了超过某些目标量级数据的作业的比例，或者在某个时间窗口内成功处理了传入记录的比例）
- 存储
    - 持久性（写入记录可以被成功读取的比例）

- SLI 数据源：应用服务器日志、负载均衡器监控、黑盒监控、客户端嵌码
- 使用历史 SLI 数据得到初始 SLO


### 选择合适的时间窗口
建议用周作为合适的时间窗口（周末流量高峰），防止长时间窗口更多的不确定性

### 获取所有利益干系者的认同

宽松的 SLO 还是严谨的 SLO？
- SRE 觉得劳民伤财
- 开发团队和产品经理觉得修复可靠性需要投入更多资源吗，导致发布速度降低至不能接受的程度
- 产品经理觉得是否让相当大量的用户感到崩溃

错误预算一旦耗尽：
- 开发团队需要找出与可靠性相关优先级最高的缺陷
- 开发团队需要专注于修复可靠性缺陷，暂缓外部特性开发需求
- 生产环境需要冻结，某些系统需要停止变更，知道错误预算恢复

SLO 和错误预算策略应该文档化。

SLO 报表：展示各个服务 SLO 是否达标以及 SLI 趋势。
错误预算消耗图：展示某个服务错误预算消耗情况。

### SLO 目标持续改进

需要一个可以获取用户对服务满意度的信息源，比如：
- 公共论坛帖子、工单、客服热线，人工统计，得出服务中断次数
- 评估和分析社交媒体上用户情绪的宣泄（积极？消极？）
- 定期的用户满意度调查程序
- 面对面用户访谈调查采样

如果故障时间或工单数量陡增没有被 SLI 或 SLO 捕捉到，或 SLI 下降和 SLO 不达标没有反映出实际问题，就是 SLO 覆盖度低的表现，需要持续改进：
- 变更 SLO：放宽或收紧
- 变更 SLI 实现：将服务端指标移到 LB 或用户端
- SLO 要符合现实：在满意度和成本之间妥协
- 迭代：时候评审

### 基于 SLO 和错误预算的决策

SLO 决策矩阵

|  SLO  | 琐事 | 客户满意度 |                      行动                       |
| ----- | ---- | --------- | ----------------------------------------------- |
| 达标   | 低   | 高        | 继续保持，或将重心转移到其他更需要可靠性的服务上     |
| 达标   | 低   | 低        | 收紧 SLO                                        |
| 达标   | 高   | 高        | 降低敏感度、放宽 SLO、提高自动化故障恢复（消除琐事） |
| 达标   | 高   | 低        | 收紧 SLO                                        |
| 不达标 | 低   | 高        | 放宽 SLO                                        |
| 不达标 | 低   | 低        | 提高告警敏感度                                   |
| 不达标 | 高   | 高        | 放宽 SLO                                        |
| 不达标 | 高   | 低        | 提高自动化故障恢复（消除琐事）                     |

### 进阶主题

SLO 应该以改善用户体验为核心。SLI 的制定应该从用户行为出发。
SLO 按用户等级（付费、免费）分组，按预期响应度（100ms、5s）分组。
依赖服务的 SLO 也要考虑在整体 SLO 之内。
对可用性进行可控的实验，可以挖掘 SLI 与用户满意度之间的关系。

## SLO 工程案例研究

### Evernote 的 SLO 故事

错误预算/SLO 模式可以促使开发和运维两个团队在相同的前提条件下做出相近的决定，因为 SRE 消除了对话中大量的主观性。

将实体数据中心迁移至公共云平台。
导入 SLO，所有团队向 SLO 看齐。
与云平台共享 SLO，目标对齐，共同担当成功或失败。

### Home Depot 的 SLO 故事

VALET

- Volume：容量（流量），服务可以处理多少业务量
- Availability：可用性，服务是否在需要时可用
- Latency：延迟，服务能否快速响应
- Errors：服务是否会出错
- Tickets：工单，服务请求是否需要人工干预才能完成


## 监控


### 监控系统应该实现的目标
- 在需要人工接入的情况下，发出告警
- 调查或诊断这些问题
- 展示有关于系统的可视化信息
- 获取有关资源使用率或服务健康度的趋势分析，用于制定长期的规划
- 比较系统变更前后的行为，或者比较两个实验组的差距

### 监控系统的必备特性
- 数据获取速度，对事件作出响应的速度
- 计算，对监控指标做离线分析（周报，日报）
- 仪表盘（曲线图、热图、直方图、对数刻度表）
- 告警，告警抑制（多个节点同时触发告警，只需要发送一次；依赖的服务触发告警时，并不需要为自己的服务发出告警）


### 监控数据源（日志、指标、分布式追踪、运行态自查）
- 日志：优点精度高，缺点延时高
- 指标：缺点颗粒度低，优点实时性高
- 用指标来配置仪表盘和告警，用日志定位问题根本原因
- 将日志导出为指标，用于图表和告警
- 维护一个类库，集成到每个应用程序的框架语言中，在关键逻辑处调用来写入日志或导出指标。
- 告警触发后自动执行日志查询脚本，返回详细数据

### 管理监控系统
- 配置即代码（Configuration as Code）：将系统配置视为代码存储在 VCS 中。
    - 保存了更改历史记录；把特定变更与任务跟踪系统（Jira）关联起来；易于回滚和语法语义检查；强化了代码评审流程的执行。
    - 按意图配置的监控系统优于只提供 Web UI 或 CRUD API 的系统。
 - 如果所有服务都能导出一组一致的基础指标，就可以在整个组织范围内自动化采集这些指标，并提供一致的仪表盘。
 - 监控组件之间应该松耦合，确保稳定的监控接口。比如数据采集与规则计算（Prometheus）、长期时间序列存储（InfluxDB）、告警聚合（Alertmanager）、仪表盘（Grafana）。

### 度量指标的意图
- SLI 指标应该放在最明显的位置上。
- 监控二进制文件的版本；监控命令行参数；监控动态配置的版本（或监控最新一次编译或打包的时间戳）。
- 监控直接依赖的服务的响应状态。
- 饱和度监控：当资源有硬性限制时；当超过阈值就会导致性能降级时。
- 服务流量（状态码以及速率配额限制监控）
- 用于告警还是用于排错。

### 测试告警逻辑
通过仿真数据测试监控告警系统的正确性。

## 基于 SLO 的告警

评估一条告警策略时，应该考虑：
- 精确率：告警事件中重大事件所占的比例
- 召回率：所有客观重大事件中，告警覆盖到的比例是多少
- 检测用时：在特定条件下发出告警通知需要多长时间
- 重置用时：问题解决之后告警还会持续多长时间

基于多个错误预算燃烧率发出告警


处理低流量服务的告警方法：
- 生成人工流量
- 组合多个服务
- 改变服务和基础设施，降低单个失败请求对用户的影响
- 降低 SLO，延长告警时间窗口

强烈建议不要为每个服务单独设定告警时间窗口和燃烧率参数。如果这样做，大量的琐事和各种特殊情况的具体分析工作会堆积如山。

根据相似可用性要求和阈值所设置的请求分组：

|  请求类别  | 可用性 | 延迟 p90 | 延迟 p99 |         举例         |
| --------- | ------ | -------- | -------- | -------------------- |
| CRITICAL  | 99.99% | 100ms    | 200ms    | 用户登录             |
| HIGH_FAST | 99.9%  | 100ms    | 200ms    | 浏览广告收入          |
| HIGH_SLOW | 99.9%  | 1000ms   | 5000ms   | 查看广告活动报告      |
| LOW       | 99%    | 无       | 无       | 处理账户通知的轮询程序 |
| NO_SLO    | 无     | 无       | 无       | 用户完全不可见的功能   |

## 消除琐事

### 琐事的定义
与维护服务相关的、重复发生的、可预测的、常规的任务流。

手动性、重复性、可自动化、非战术性/被动性、没有持久价值、与服务规模同步增长。

比如：当服务器上 /var/log 目录达到 95% 使用率的时候，工程师登录到机器，删除掉无用的日志文件。

时间一旦花在了琐事上，通常就没有用在批判性思考或表达创意力方面的时间了；削减琐事是对工程师人类智慧的认可，人类的判断和表达能力将在与之适合的领域中得到了更好地发挥。

通过消除琐事所节省的时间（至少）要与首次开发工作以及后续维护自动化解决方案所投入的时间成正比。

### 自动化工具潜在的收益
- 随着时间的推移和业务规模的增长，可以减少未来的琐事
- 提高团队士气，减少团队人员流失和透支的情况
- 降低上下文切换的中断，从而提高团队的工作效率
- 提高流程的清晰度和标准化
- 提高团队成员的技术水平和职业发展
- 更少的培训时间
- 减少人为错误导致的宕机
- 提高安全性
- 更短的用户请求响应时间

### 琐事来源
#### 业务流程
举例：资源管理团队，管理着计算、存储、网络、负载均衡器、数据库，以及提供这些资源所需要的硬件。你的工作是负责处理新用户注册，配置他们的计算机并加固其安全性，执行软件更新，或者为调节集群容量而添加或删除服务器。最大限度地降低所使用资源的成本和浪费。通过工单方式与有需求的内部客户进行交互。
#### 生产中断
举例：手动释放磁盘空间，重新启动内存泄露的应用程序，提交工单更换硬盘驱动器。
#### 产品发布
举例：发布请求、回滚、紧急补丁、重复性或手动配置更改。
#### 迁移
数据存储、云供应商、源代码控制系统、应用程序库和工具的改变。
#### 工程成本和容量规划
- 制定 CPU、内存、IOPS 等资源在未来的需求计划，可能转化为资源采购订单、公有云预留实例或合同谈判。
- 为关键的高流量时间开始和结束做准备，如产品发布或假期促销。
- 检查下游和尚有的服务水平/限制。
- 根据不同的服务规格优化工作负载（买一个高配虚拟机还是四个低配虚拟机？）。
- 根据云服务产品特有的计费希捷优化应用程序。
- 重构工具以更好地使用更便宜的竞价实例或可抢占式资源。
- 处理超额购买的资源。
#### 不透明架构的故障排查
举例：分布式微服务架构故障排除工作需要登录到不同的系统或使用临时编写的日志分析工具。

### 琐事管理策略

- 采用数据驱动的方式识别琐事源头
- 尝试在源头上消灭琐事
- 拒绝琐事
- 根据 SLO 做出明确的决策
- 从半自动化开始
- 提供各种自助服务方法（表单、二进制、脚本、API，甚至文档）
- 获得管理层和同事的支持（通过拒绝新需求的方式保护员工免受打扰至关重要）
- 大力推广
- 不要试图设计一个没有琐事的完美系统。可以自动化一些高优先级的事情，再用节省下来的时间去做更多的改进。
- 设施统一化。团队可以自由选择自己的方法，但必须自己承担遗留系统所产生的琐事。
- 降低自动化带来的风险（防御性地处理用户输入，完整的安全检查，适时切换为人工处理）
- 使用开源和第三方工具（降低开发成本）
- 积极地收集反馈，不断进行改进

## 简单性

简单性应该是 SRE 一个重要的目标，与可靠性密切相关。
简单的软件不会经常发生故障，即是出了问题，修复起来也很快、也更容易。
简单的系统更易于理解、维护和测试。

系统级复杂性的度量
- 培训时间（文档缺失或文档质量较低）
- 解释时间（架构图）
- 管理的多样性（配置文件集中存储还是分散在多个位置）
- 部署配置的多样性（生产环境有多少种独有的配置）
- 年龄（系统使用了多久）

SRE 团队应该负责降低系统的复杂性，绘制系统的架构图是一个很好的开始，同时确保 SRE 参与评审所有的设计文档。
我们要把成功的简化项目视为和发布新功能一样，并把添加代码和删除代码的功劳同等看待。

## On-call 轮值

TBD

